# X-Ray 流量监控工具 - 更新日志

## v2.4 (2025-11-17) - 当前版本

### 🔥 重要更新

**采集间隔优化：从5分钟调整为1分钟**

### 改进内容

#### 1. 采集间隔缩短
- **旧版本 (v2.3)**: 5分钟 (300秒)
- **新版本 (v2.4)**: 1分钟 (60秒)

#### 2. 优势
- ✅ **更快获得数据**: 启动后1-2分钟即可查询
- ✅ **更精细的统计**: 更频繁的数据采集点
- ✅ **更快速的异常检测**: 异常流量能更快发现
- ✅ **更准确的流量趋势**: 更密集的数据点
- ✅ **平衡性能**: 1分钟间隔既快又不过于频繁

#### 3. 数据量影响
- **采集频率**: 从每天288次增加到1440次
- **数据量**: 从每天约17KB增加到约85KB
- **月数据量**: 从约500KB增加到约2.5MB（依然很小）

### 使用变化

#### 等待时间缩短
- **v2.3**: 启动服务后需等待5-10分钟才有数据
- **v2.4**: 启动服务后只需等待2-3分钟即可查询

#### 查询示例
```bash
# 启动服务
xray-monitor start

# 等待2-3分钟后即可查询
xray-monitor query 1   # 查询最近1分钟
xray-monitor query 5   # 查询最近5分钟
xray-monitor query 10  # 查询最近10分钟
xray-monitor query 60  # 查询最近1小时
```

### 升级方法

```bash
# 1. 停止服务（保留数据）
xray-monitor stop

# 2. 重新安装 v2.4
bash <(curl -sL https://raw.githubusercontent.com/huanshenweb/xrayCheck/refs/heads/main/xray-monitor-install-db.sh)

# 3. 启动服务
xray-monitor start

# 4. 等待1-2分钟后查询
xray-monitor query 1
```

### 注意事项

⚠️ **如果服务器流量很大**（数百或上千个活跃IP），1分钟的采集间隔可能会：
- 增加 iptables 规则数量
- 稍微增加系统开销
- 建议根据实际情况调整

如需调整采集间隔，可以编辑脚本中的 `INTERVAL` 变量：
```bash
vi /usr/local/bin/xray-monitor
# 找到 INTERVAL=60，修改为其他值（单位：秒）
# 例如：INTERVAL=30   (30秒，更快)
#      INTERVAL=120  (2分钟)
#      INTERVAL=300  (5分钟，旧版本)
#      INTERVAL=600  (10分钟，低频采集)
```

---

## v2.3 (2025-11-17)

### 关键修复
- ✅ 修复列号错误（对端IP在第4列，不是第5列）
- ✅ 完善IPv6映射格式支持
- ✅ 优化IP提取逻辑
- ✅ 首个完全可用的版本

### 问题解决
- 修复 `xray-monitor test` 显示"唯一IP: 0"的问题
- 修复实时监控IP统计错误
- 修复流量采集IP提取失败

---

## v2.2 (2025-11-17)

### 改进
- ⚠️ 尝试支持IPv6映射格式（列号错误）
- ✅ 使用 sed 处理 `[::ffff:x.x.x.x]:port` 格式

### 问题
- ❌ 使用了错误的列号（$5应为$4）

---

## v2.1 (2025-11-17)

### 新增功能
- ✅ 新增 `test` 命令用于诊断

### 改进尝试
- ⚠️ 尝试优化IP提取（失败）

---

## v2.0 (2025-11-17)

### 首个数据库版本
- ✅ 自动采集功能
- ✅ SQLite数据库存储
- ✅ 历史查询功能
- ✅ 流量排名功能
- ⚠️ IP提取存在问题（未支持IPv6映射格式）

---

## v1.0 (简单版)

### 基础功能
- ✅ 基础流量监控
- ✅ 实时连接状态
- ✅ 流量排名
- ✅ 智能端口检测
- ❌ 数据不保存

---

## 版本对比总结

| 版本 | 状态 | 采集间隔 | IP提取 | 主要问题 |
|------|------|---------|--------|----------|
| v1.0 | ⚠️ | 手动触发 | ✅ | 数据不保存 |
| v2.0 | ❌ | 5分钟 | ❌ | IP提取失败 |
| v2.1 | ❌ | 5分钟 | ❌ | IP提取失败 |
| v2.2 | ❌ | 5分钟 | ❌ | 列号错误 |
| v2.3 | ✅ | 5分钟 | ✅ | 完全可用 |
| **v2.4** | **✅** | **1分钟** | **✅** | **当前版本** |

---

## 推荐升级版本

### 必须升级（严重问题）
- v2.0, v2.1, v2.2 → v2.4（IP提取失败）

### 建议升级（功能改进）
- v2.3 → v2.4（更快的数据采集）

### 可选升级
- v1.0（简单版）→ v2.4（如需数据持久化）

---

## 后续计划

### 可能的功能增强
- 支持自定义采集间隔（通过配置文件）
- 支持WebUI可视化界面
- 支持告警功能（流量异常通知）
- 支持多端口同时监控
- 支持流量限额管理

---

## 反馈与建议

如有问题或建议，欢迎反馈：
- GitHub Issues: https://github.com/huanshenweb/xrayCheck/issues

---

**当前稳定版本: v2.4** ⭐

